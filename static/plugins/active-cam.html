<script>
    kiwi.plugin('active-cam', function (kiwi, log) {

        // kiwi.addUi('header_channel', button.$mount().$el);

        kiwi.Vue.component('button-counter', {
            template: `            
 <div class="container" style="height: 362px ; width:100%;float:left">

    <div class="stream" style="
                            float:left
                            display: ruby;
                            height: 100%;
                            display: block ruby;
                            width:100%;">
        <ul style=" height: 250px;  list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
        width: max-content;">
            <li style="float: left; padding: 0px 20px;"> <iframe id="camera-preview" :src="this.getIframe()" frameborder="0" style=" 
                height: 250px;
                            
                            float: left;" allow="camera; microphone">
                </iframe></li>

        </ul>
    </div>
</div>
`,


            data() {
                return {
                    isPreviewVisible: false,
                    iframeElement: null,
                    permissionsGranted: false,
                    valor1: '',
                    items: kiwi.viewedUsers
                };
            },
            computed: {
                getView() {
                    return this.items;
                },

            },
            methods: {
                getIframe() {
                    return 'http://localhost:4000/broadcast.html?user=' + this.$state.getActiveNetwork().nick;
                },
                buttonClicked() {
                    this.toggleCameraPreview();
                },
                toggleCameraPreview() {
                    this.isPreviewVisible = !this.isPreviewVisible;
                    if (this.isPreviewVisible) {
                        this.requestPermissions();
                    }
                },
                requestPermissions() {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                        .then(() => {
                            this.permissionsGranted = true;
                            this.showCamera();
                        })
                        .catch(error => {
                            console.error('Error al solicitar permisos:', error);
                            this.permissionsGranted = false;
                            alert('Permisos de cÃ¡mara no concedidos.');
                        }).then(() => this.showCamera());
                },
                showCamera() {
                    this.iframeElement = document.getElementById('camera-preview');
                    if (this.iframeElement) {
                        this.iframeElement.style.display = 'block'; // Muestra el iframe
                        this.valor1 = 'https://webrtc-video-broadcast-dtc0.onrender.com/?user=' + this.$state.getActiveNetwork().nick;
                        // Envia el comando para mostrar la cÃ¡mara
                        const network = this.$state.getActiveNetwork();
                        if (network && this.valor1) {
                            network.ircClient.raw(`setname ${this.valor1}`);
                        } else {
                            console.error('Red activa o valor1 no disponible.');
                        }
                    } else {
                        console.error('El iframe no se encontrÃ³ en el DOM.');
                    }

                },
                hideCamera() {
                    const network = this.$state.getActiveNetwork();
                    if (network) {
                        network.ircClient.raw('SETNAME ' + this.$state.getActiveNetwork().nick);
                    }
                },
                closeCam(value) {
                    kiwi.viewedUsers.splice(value,1); 
                }



            },

            beforeDestroy() {
                this.hideCamera(); // Limpia el iframe si existe
                kiwi.viewedUsers.splice(0, kiwi.viewedUsers.length)
            },
            mounted() {
                this.showCamera();
                var iframe = document.getElementById("camera-preview");
                iframe.width = iframe.contentWindow.document.body.scrollWidth;
                iframe.height = iframe.contentWindow.document.body.scrollHeight;

            },
        })



        function loginFn() {
            kiwi.state.$emit('mediaviewer.show', { component: 'button-counter' });
        }

        var loginBtn = document.createElement('a');
        loginBtn.innerHTML = '<i class="fa fa-video-camera" aria-hidden="true">(beta)</i>';
        loginBtn.addEventListener("click", loginFn);
        kiwi.addUi('header_channel', loginBtn);

    });
</script>